<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Simple API Viewer | MGNREGA Helper</title>
	<style>
		:root {
			--bg: #0b1021;
			--card: #151a2f;
			--ink: #eaf0ff;
			--muted: #9fb0d3;
			--accent: #3ddc97;
			--accent-2: #4aa8ff;
			--danger: #ff6b6b;
		}
		* { box-sizing: border-box; }
		body {
			margin: 0;
			font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, Noto Sans, "Apple Color Emoji", "Segoe UI Emoji";
			background: radial-gradient(1200px 600px at 20% -10%, #1b2250 0%, var(--bg) 60%),
				radial-gradient(1000px 500px at 120% 0%, #0f1636 0%, transparent 50%);
			color: var(--ink);
		}
		header {
			padding: 20px 16px;
			text-align: center;
		}
		header h1 {
			margin: 0 0 6px 0;
			font-size: 28px;
		}
		header p { margin: 0; color: var(--muted); font-size: 16px; }
		header .hi { font-size: 18px; color: var(--ink); }
		.container {
			max-width: 980px;
			margin: 0 auto;
			padding: 16px;
		}
		.card {
			background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.0));
			border: 1px solid rgba(255,255,255,0.08);
			border-radius: 16px;
			box-shadow: 0 10px 30px rgba(0,0,0,0.25);
			padding: 16px;
		}
		.card-filters {
			background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0));
			border: 1px solid rgba(255,255,255,0.18);
			border-radius: 18px;
			box-shadow: 0 4px 8px rgba(61,220,151,0.06);
			padding: 22px 12px 14px 12px;
			margin-bottom: 24px;
		}
		@media (min-width: 600px) {
			.filters-row {
				display: flex;
				gap: 18px;
				align-items: flex-end;
				justify-content: flex-start;
			}
		}
		.filters-row > div {
			flex:1;
			min-width: 140px;
			margin-bottom: 0;
		}
		.filters-row button {
			margin-left: 6px;
		}
		@media (max-width:600px) {
			.filters-row { display:block; }
			.filters-row > div { margin-bottom:10px; }
		}
		.card .form-row { margin-bottom: 0; }
		.form-row { display: grid; gap: 10px; }
		@media (min-width: 720px) {
			.form-row { grid-template-columns: 1fr auto; align-items: end; }
		}
		label { font-size: 14px; color: var(--muted); margin-bottom: 6px; display: block; }
		input[type="text"], textarea, select {
			width: 100%;
			padding: 12px 12px;
			border-radius: 10px;
			border: 1px solid rgba(255,255,255,0.12);
			background: #0e1430;
			color: var(--ink);
			font-size: 16px;
		}
		textarea { min-height: 72px; resize: vertical; }
		button {
			padding: 14px 16px;
			border-radius: 10px;
			border: none;
			background: linear-gradient(180deg, var(--accent), #1fb87b);
			color: #06101a;
			font-weight: 700;
			font-size: 16px;
			cursor: pointer;
			box-shadow: 0 6px 16px rgba(61, 220, 151, 0.35);
		}
		button.secondary { background: linear-gradient(180deg, var(--accent-2), #2282e3); color: #041018; box-shadow: 0 6px 16px rgba(74,168,255,0.35); }
		button.ghost { background: transparent; color: var(--ink); border: 1px solid rgba(255,255,255,0.12); box-shadow: none; }
		button:disabled { opacity: 0.6; cursor: not-allowed; }
		.helper {
			margin-top: 6px;
			font-size: 14px;
			color: var(--muted);
		}
		.kv-grid { display: grid; gap: 8px; }
		@media (min-width: 720px) { .kv-grid { grid-template-columns: repeat(2, 1fr); } }
		.kv {
			background: #0f1536;
			border: 1px solid rgba(255,255,255,0.08);
			border-radius: 10px;
			padding: 10px;
			display: grid;
			grid-template-columns: 140px 1fr auto;
			gap: 8px;
			align-items: center;
		}
		.kv input { width: 100%; }
		.row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
		.badge { background: #0e1538; border: 1px solid rgba(255,255,255,0.12); padding: 6px 10px; border-radius: 999px; color: var(--muted); font-size: 13px; }
		.results {
			margin-top: 16px;
		}
		.status {
			padding: 10px 12px;
			border-radius: 10px;
			border: 1px solid rgba(255,255,255,0.12);
			background: #0f1536;
			font-size: 14px;
			color: var(--muted);
		}
		.status strong { color: var(--ink); }
		pre.json {
			white-space: pre-wrap;
			word-break: break-word;
			background: #0b1230;
			border: 1px solid rgba(255,255,255,0.08);
			border-radius: 10px;
			padding: 12px;
			font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
			font-size: 13px;
		}
		.table-wrap { overflow: auto; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); }
		table { width: 100%; border-collapse: collapse; background: #0b1230; }
		th, td { border-bottom: 1px solid rgba(255,255,255,0.06); padding: 10px 12px; text-align: left; font-size: 14px; }
		th { position: sticky; top: 0; background: #0e1538; color: var(--muted); }
		.footer { margin: 24px 0 32px; text-align: center; color: var(--muted); font-size: 14px; }
		.footer a { color: var(--accent-2); text-decoration: none; }
		.hindi { font-size: 16px; color: var(--ink); }
	</style>
</head>
<body>
	<header>
		<h1>MGNREGA — Chhattisgarh</h1>
		<p class="hi">अपने ज़िले का प्रदर्शन देखें • See your district’s performance</p>
	</header>

	<div class="container">
		<div class="card card-filters">
			<form onsubmit="event.preventDefault(); fetchData();" autocomplete="off">
				<div class="filters-row">
					<div>
						<label>District (Chhattisgarh)</label>
						<select id="district"></select>
					</div>
					<div>
						<label>Month</label>
						<select id="month"></select>
					</div>
					<div>
						<label>Year</label>
						<select id="year"></select>
					</div>
					<div style="display:flex;gap:8px;align-items:end;">
						<button id="fetchBtn" class="primary" type="submit" style="min-width:90px;">Fetch</button>
						<button id="clearBtn" class="ghost" type="button">Clear</button>
					</div>
				</div>
				<div class="helper" style="margin-top:10px">उदाहरण: रायपुर, दुर्ग, बिलासपुर • Example: Raipur, Durg, Bilaspur</div>
			</form>
		</div>
		<div class="results">
			<div id="status" class="status" style="display:none"></div>
			<div id="tableWrap" class="table-wrap" style="display:none">
				<table id="dataTable"></table>
			</div>
			<pre id="json" class="json" style="display:none"></pre>
			<div class="row" id="actions" style="display:none; margin-top: 10px;">
				<button id="downloadCsv" class="secondary">Download CSV</button>
				<button id="copyJson" class="ghost">Copy JSON</button>
			</div>
		</div>
		<div class="footer">
			<div>All Copyrights Reserved</div>
		</div>
	</div>
	<script>
		const districtEl = document.getElementById('district');
		const monthEl = document.getElementById('month');
		const yearEl = document.getElementById('year');
		const fetchBtn = document.getElementById('fetchBtn');
		const clearBtn = document.getElementById('clearBtn');
		const statusEl = document.getElementById('status');
		const jsonEl = document.getElementById('json');
		const tableWrap = document.getElementById('tableWrap');
		const dataTable = document.getElementById('dataTable');
		const actionsEl = document.getElementById('actions');
		const downloadCsvBtn = document.getElementById('downloadCsv');
		const copyJsonBtn = document.getElementById('copyJson');
		let lastData = null;
		const DISTRICTS = [
			'Raipur','Durg','Bilaspur','Raigarh','Korba','Janjgir-Champa','Balod','Baloda Bazar','Balrampur',
			'Bastar','Bemetara','Bijapur','Dantewada','Dhamtari','Gariaband','Jashpur','Kanker','Kondagaon',
			'Koriya','Mahasamund','Mungeli','Narayanpur','Sukma','Surajpur','Surguja','Kabirdham (Kawardha)',
			'Gaurela-Pendra-Marwahi','Sarangarh-Bilaigarh','Manendragarh-Chirmiri-Bharatpur',
			'Khairagarh-Chhuikhadan-Gandai','Mohla-Manpur-Ambagarh Chowki','Sakti'
		];
		const HINDI_DISTRICTS = [
			'रायपुर','दुर्ग','बिलासपुर','रायगढ़','कोरबा','जांजगीर-चांपा','बालोद','बलौदा बाजार','बलरामपुर',
			'बस्तर','बेमेतरा','बीजापुर','दन्तेवाड़ा','धमतरी','गरियाबंद','जशपुर','कांकेर','कोंडागांव',
			'कोरिया','महासमुंद','मुंगेली','नारायणपुर','सुकमा','सूरजपुर','सूरजपुर','कबीरधाम (कवर्धा)',
			'गौरेला-पेंड्रा-मरवाही','सरगुजा-बिलाईगढ़','मनेन्द्रगढ़-चिरमिरी-भरतपुर',
			'खैरागढ़-छुईखदान-गंडई','मोहला-मानपुर-अंबागढ़ चौकी','सक्ति'
		];
		(function initSelectors() {
			districtEl.innerHTML = DISTRICTS.map((d, i) => `<option value="${d}">${d} (${HINDI_DISTRICTS[i] || ''})</option>`).join('');
			const savedDist = localStorage.getItem('cg_district');
			if (savedDist && DISTRICTS.includes(savedDist)) districtEl.value = savedDist;
			const months = [
				'01','02','03','04','05','06','07','08','09','10','11','12'
			];
			monthEl.innerHTML = months.map((m,i)=> `<option value="${m}">${m}</option>`).join('');
			const mm = String(new Date().getMonth()+1).padStart(2,'0');
			monthEl.value = mm;
			const nowY = new Date().getFullYear();
			const years = Array.from({length: 6}, (_,k)=> nowY-k);
			yearEl.innerHTML = years.map(y=> `<option value="${y}">${y}</option>`).join('');
			yearEl.value = String(nowY);
		})();
		function showStatus(text, ok = true) {
			statusEl.style.display = 'block';
			statusEl.style.borderColor = ok ? 'rgba(61,220,151,0.45)' : 'rgba(255,107,107,0.45)';
			statusEl.style.background = ok ? '#0f1f36' : '#2a0f16';
			statusEl.innerHTML = text;
		}
		function hideOutputs() {
			statusEl.style.display = 'none';
			jsonEl.style.display = 'none';
			tableWrap.style.display = 'none';
			actionsEl.style.display = 'none';
		}
		function isLikelyArrayOfObjects(obj) {
			return Array.isArray(obj) && obj.length && typeof obj[0] === 'object' && !Array.isArray(obj[0]);
		}
		function renderTableFromArray(arr) {
			const columns = [...arr.reduce((set, item) => {
				Object.keys(item || {}).forEach(k => set.add(k));
				return set;
			}, new Set())];
			let thead = '<thead><tr>' + columns.map(c => `<th>${escapeHtml(c)}</th>`).join('') + '</tr></thead>';
			let tbody = '<tbody>' + arr.map(row => {
				return '<tr>' + columns.map(c => `<td>${escapeHtml(formatCell(row[c]))}</td>`).join('') + '</tr>';
			}).join('') + '</tbody>';
			dataTable.innerHTML = thead + tbody;
		}
		function escapeHtml(v) {
			if (v === null || v === undefined) return '';
			return String(v)
				.replaceAll('&', '&amp;')
				.replaceAll('<', '&lt;')
				.replaceAll('>', '&gt;');
		}
		function formatCell(v) {
			if (v === null || v === undefined) return '';
			if (typeof v === 'object') return JSON.stringify(v);
			return v;
		}
		function toCsv(arr) {
			const cols = [...arr.reduce((s, r) => { Object.keys(r||{}).forEach(k=>s.add(k)); return s; }, new Set())];
			const lines = [cols.map(c => '"' + String(c).replaceAll('"', '""') + '"').join(',')];
			for (const r of arr) {
				lines.push(cols.map(c => '"' + String(r?.[c] ?? '').replaceAll('"', '""') + '"').join(','));
			}
			return lines.join('\n');
		}
		async function fetchData() {
			hideOutputs();
			const district = districtEl.value;
			const month = monthEl.value;
			const year = yearEl.value;
			if (!district) { showStatus('Please select a district.', false); return; }
			fetchBtn.disabled = true;
			showStatus('Fetching…');
			const t0 = performance.now();
			try {
				localStorage.setItem('cg_district', district);
				const q = new URLSearchParams({ district, month, year });
				const res = await fetch(`/api/mgnregs/chhattisgarh/monthly?${q.toString()}`);
				const bytes = +(res.headers.get('content-length') || 0);
				const text = await res.text();
				let data;
				let parseFailed = false;
				try { data = JSON.parse(text); } catch(e) { data = text; parseFailed = true; }
				console.log('DATA:', data);
				const t1 = performance.now();
				lastData = data;
				const statusLine = `<strong>Status:</strong> ${res.status} ${res.statusText} · <strong>Time:</strong> ${(t1-t0).toFixed(0)}ms · <strong>Size:</strong> ${bytes ? (bytes/1024).toFixed(1)+ ' KB' : 'unknown'}`;
				showStatus(statusLine, res.ok);
				function isArrayOfObjects(val) {
					return Array.isArray(val) && val.length > 0 && typeof val[0] === 'object';
				}
				let tableRows = null;
				if (data && typeof data === 'object' && isArrayOfObjects(data.records)) {
					tableRows = data.records;
				} else if (isArrayOfObjects(data)) {
					tableRows = data;
				}
				const htmlLike = typeof data === 'string' && data.trim().startsWith('<!DOCTYPE html');
				if (parseFailed || htmlLike || !tableRows) {
					jsonEl.textContent = '';
					tableWrap.style.display = 'none';
					actionsEl.style.display = 'none';
					showStatus('No MGNREGA data found for this selection. Please try a different district/month or contact your local authority.', false);
					return;
				}
				if (tableRows && tableRows.length > 0) {
					const perfFields = [
						['Approved_Labour_Budget',      'अनुमोदित श्रम बजट / Approved Labour Budget'],
						['Total_Exp',                   'कुल व्यय / Total Expenditure'],
						['Total_Households_Worked',     'कुल परिवारों ने काम किया / Total Households Worked'],
						['Total_Individuals_Worked',    'कुल व्यक्तियों ने काम किया / Total Individuals Worked'],
						['Total_No_of_JobCards_issued', 'जॉबकार्ड जारी / JobCards Issued'],
						['Total_No_of_Active_Job_Cards','सक्रिय जॉबकार्ड / Active Job Cards'],
						['Total_No_of_Active_Workers',  'सक्रिय मज़दूर / Active Workers'],
						['Persondays_of_Central_Liability_so_far','कुल व्यक्ति-दिन (अब तक) / Persondays (Central Liability)'],
						['SC_persondays',               'SC व्यक्ति-दिन / SC Persondays'],
						['ST_persondays',               'ST व्यक्ति-दिन / ST Persondays'],
						['Women_Persondays',            'महिला व्यक्ति-दिन / Women Persondays'],
						['Wages',                       'मज़दूरी (₹ लाख) / Wages (in lakhs)'],
						['Average_Wage_rate_per_day_per_person', 'औसत मजदूरी दर (₹/दिन) / Avg Wage Rate'],
						['Average_days_of_employment_provided_per_Household','औसत रोजगार दिन / Avg Days Employment/HH'],
						['Number_of_Completed_Works',   'पूरा किए कार्य / Completed Works'],
						['Number_of_Ongoing_Works',     'चल रहे कार्य / Ongoing Works'],
						['percent_of_Category_B_Works', '% श्रेणी बी कार्य / % Category B Works'],
						['percent_of_Expenditure_on_Agriculture_Allied_Works', '% कृषि-आधारित खर्च / % Agri. Expenditure'],
						['Remarks',                     'टिप्पणी / Remark']
					];
					const r = tableRows[0];
					let perfHtml = '<div class="card" style="margin-bottom:24px; background:#172040;">';
					perfHtml += '<h2 style="margin-top:0;">\u091C\u093F\u0932\u093E प्रदर्शन • District Performance</h2>';
					perfFields.forEach(([k, label]) => {
						if (r[k] !== undefined && r[k] !== null && String(r[k]).trim() !== '') {
							perfHtml += `<div style="display:flex;gap:12px;justify-content:space-between;align-items:center;margin:4px 0;border-bottom:1px dotted #283256;padding:2px 0;">
								<span style="color:#9fb0d3">${label}</span> <span style="color:#fff;font-weight:700;">${escapeHtml(r[k])}</span>
							</div>`;
						}
					});
					perfHtml += '</div>';
					perfHtml = `
						<div style='text-align:center;margin-bottom:18px;'>
							<span style='color:#bbf;font-size:2rem;font-weight:700;'>${escapeHtml(districtEl.value)}</span>
							<span style='color:#7cc;font-size:1.25rem;padding:0 12px;'>${monthEl.options[monthEl.selectedIndex].text}-${yearEl.value}</span>
						</div>
					` + perfHtml;
					let perfNode = document.getElementById('perfSummary');
					if (!perfNode) {
						perfNode = document.createElement('div');
						perfNode.id = 'perfSummary';
						document.querySelector('.container').insertBefore(perfNode, document.querySelector('.results'));
					}
					perfNode.innerHTML = perfHtml;
					const detailsBtnId = 'toggleDetails';
					let detailsBtn = document.getElementById(detailsBtnId);
					if (!detailsBtn) {
						detailsBtn = document.createElement('button');
						detailsBtn.id = detailsBtnId;
						detailsBtn.className = 'secondary';
						detailsBtn.style.marginBottom = '18px';
						detailsBtn.innerText = 'Show Detailed Table';
						perfNode.appendChild(detailsBtn);
					}
					if (document.getElementById('toggleDetails')) {
						document.getElementById('toggleDetails').innerText = 'Show Detailed Table';
						tableWrap.style.display = 'none';
						let btn = document.getElementById('toggleDetails');
						btn.onclick = function() {
							if (tableWrap.style.display === 'none') {
								tableWrap.style.display = 'block';
								btn.innerText = 'Hide Detailed Table';
							} else {
								tableWrap.style.display = 'none';
								btn.innerText = 'Show Detailed Table';
							}
						};
					}
				}
				else {
					let perfNode = document.getElementById('perfSummary');
					if (perfNode) perfNode.innerHTML = '';
				}
				renderTableFromArray(tableRows);
				actionsEl.style.display = 'flex';
			} catch (err) {
				showStatus('Failed to fetch. ' + (err?.message || err), false);
				console.error(err);
			} finally {
				fetchBtn.disabled = false;
			}
		}
		function downloadCsv() {
			let arr = null;
			if (isLikelyArrayOfObjects(lastData)) arr = lastData;
			else if (lastData && isLikelyArrayOfObjects(lastData.records)) arr = lastData.records;
			if (!arr) { alert('Data is not a simple table to export.'); return; }
			const csv = toCsv(arr);
			const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
			const a = document.createElement('a');
			a.href = URL.createObjectURL(blob);
			a.download = 'data.csv';
			a.click();
			URL.revokeObjectURL(a.href);
		}
		function copyJson() {
			const text = typeof lastData === 'string' ? lastData : JSON.stringify(lastData, null, 2);
			navigator.clipboard?.writeText(text).then(() => {
				showStatus('Copied JSON to clipboard.', true);
			});
		}
		function clearAll() {
			districtEl.selectedIndex = 0;
			monthEl.selectedIndex = 0;
			yearEl.selectedIndex = 0;
			localStorage.removeItem('cg_district');
			jsonEl.textContent = '';
			dataTable.innerHTML = '';
			hideOutputs();
			let perfNode = document.getElementById('perfSummary');
			if (perfNode) perfNode.innerHTML = '';
			tableWrap.style.display = 'none';
			let detailsBtn = document.getElementById('toggleDetails');
			if (detailsBtn) detailsBtn.innerText = 'Show Detailed Table';
		}
		fetchBtn.addEventListener('click', fetchData);
		clearBtn.addEventListener('click', clearAll);
		downloadCsvBtn.addEventListener('click', downloadCsv);
		copyJsonBtn.addEventListener('click', copyJson);
	</script>
</body>
</html>


